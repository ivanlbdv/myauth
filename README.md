# MyAuth — система аутентификации и авторизации

## Описание системы управления ограничениями доступа

В системе MyAuth реализована **ролевая модель контроля доступа (RBAC)** с детализированной настройкой разрешений для ресурсов. Ниже описано, как устроена схема управления ограничениями доступа.

---

## Основные сущности системы

1. **User (Пользователь)**  
   - Основная учётная запись в системе.
   - Имеет email, ФИО, пароль (хранится в зашифрованном виде), статусы (`is_active`, `is_staff`, `is_superuser`).
   - Может быть связан с одной или несколькими ролями через модель `UserRole`.

2. **Role (Роль)**  
   - Логическая группа прав (например, «администратор», «пользователь»).
   - Каждая роль имеет уникальное имя и описание.
   - Примеры: `admin`, `user`.

3. **Permission (Разрешение)**  
   - Атомарное право на выполнение действия (например, «просмотр постов», «удаление пользователей»).
   - Каждое разрешение имеет код (`code`) и описание (`description`).
   - Примеры кодов: `view_posts`, `delete_users`, `edit_profile`.

4. **Resource (Ресурс)**  
   - Объект системы, к которому регулируется доступ (например, «посты», «комментарии», «роли»).
   - Каждый ресурс имеет имя (`name`) и описание (`description`).
   - Примеры: `posts`, `comments`, `roles`.

5. **AccessRule (Правило доступа)**  
   - Связывает роль, ресурс и разрешение, определяя, разрешено ли действие.
   - Содержит поле `is_allowed` (`True` — разрешено, `False` — запрещено).
   - Уникальность: комбинация `(role, resource, permission)`.

6. **UserRole (Связь пользователя и роли)**  
   - Ассоциирует пользователя с одной или несколькими ролями.
   - Позволяет пользователю наследовать все разрешения, назначенные его ролям.

---

## Принцип работы системы доступа

1. **Назначение ролей пользователям**  
   - При регистрации пользователю автоматически назначается роль `user`.
   - Администраторы могут назначать/менять роли через API или админ‑панель.

2. **Определение разрешений для ролей**  
   - Для каждой роли создаются правила доступа (`AccessRule`), которые указывают:  
     - К какому ресурсу (`Resource`) применяется правило.  
     - Какое действие (`Permission`) разрешается или запрещается.  
     - Для какой роли (`Role`) действует правило.  
   - Пример: роль `admin` имеет разрешение `view_posts` для ресурса `posts`.

3. **Проверка доступа при запросе**  
   - При обращении к API система:  
     1. Определяет текущего пользователя (через JWT‑токен в заголовке `Authorization`).  
     2. Получает все роли пользователя.  
     3. Проверяет, существует ли правило `AccessRule`, разрешающее запрошенное действие (`permission`) для указанного ресурса (`resource`) в рамках одной из ролей.  
     4. Если правило найдено и `is_allowed = True` — доступ разрешён. Иначе — отклонён.

---

## Примеры правил доступа

### Роль `admin` (администратор)
- **Ресурсы**: `posts`, `users`, `roles`, `access_rules`, `comments`, `permissions`.  
- **Разрешения**:  
  - `view_posts`, `create_posts`, `edit_posts`, `delete_posts` (для `posts`).  
  - `view_users`, `edit_users`, `delete_users` (для `users`).  
  - И другие.

### Роль `user` (обычный пользователь)
- **Ресурсы**: `posts`, `users`, `comments`.  
- **Разрешения**:  
  - `create_posts`, `view_posts` (для `posts`).  
  - `edit_profile` (для `users` — только свой профиль).  
  - `create_comments`, `view_comments` (для `comments`).

---

## Механизмы контроля доступа в API

1. **Middleware `CustomAuthMiddleware`**  
   - Проверяет JWT‑токен в заголовке `Authorization`.  
   - Аутентифицирует пользователя и привязывает его к запросу (`request.user`).  
   - Исключает проверку для публичных эндпоинтов (регистрация, вход, выход).


2. **Permission-классы DRF**  
   - `IsAuthenticated` — проверяет, что пользователь авторизован.  
   - `HasPermission` — проверяет наличие соответствующего `AccessRule` для запрошенного действия и ресурса.  
     - Использует `resource_code` и `permission_code` из URL или контекста запроса.


3. **View-классы с проверкой прав**  
   - В каждом API‑эндпоинте явно указываются:  
     - `resource_code` (ресурс, к которому обращается запрос).  
     - `permission_code` (действие, которое пытается выполнить пользователь).  
   - Пример:  
     ```python
     class PostDetailView(APIView):
         resource_code = 'posts'
         permission_code = 'edit_posts'  # для метода PUT
     ```

---

## Инициализация данных

При запуске системы (через `init_db.py`) создаются:
- Роли: `admin`, `user`.  
- Разрешения: все перечисленные в `permissions_data`.  
- Ресурсы: все перечисленные в `resources_data`.  
- Правила доступа: для `admin` и `user` согласно предопределённым спискам (`admin_rules`, `user_rules`).  
- Администратор по умолчанию: `admin@example.com` с паролем `adminpass123`.

---

## Администрирование

- **Через админ‑панель Django**  
  - Можно управлять ролями, разрешениями, ресурсами и правилами доступа.  
  - Доступно редактирование пользователей и их ролей.  
- **Через API**  
  - Эндпоинты для CRUD ролей, разрешений, правил доступа.

---

## Ключевые особенности

- **Гибкость**: новые роли, ресурсы и разрешения можно добавлять без изменения кода.  
- **Масштабируемость**: правила доступа легко модифицировать через админ‑панель или API.  
- **Безопасность**: пароли хранятся в зашифрованном виде (bcrypt), аутентификация через JWT.  
- **Прозрачность**: все правила доступа явно прописаны и видны в админ‑панели.

---
